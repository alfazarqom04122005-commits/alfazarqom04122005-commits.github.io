<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Product Editor</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; }
  .product { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
  .info { flex: 1; }
  .actions button, .actions a { margin-left: 5px; }
  img { max-width: 100px; }
</style>
</head>
<body>

<h1>Daftar Produk</h1>
<div id="productList"></div>

<hr>
<h2>Edit Produk</h2>
<form id="editForm">
  <input type="hidden" name="myid">

  <input type="text" name="name" placeholder="Nama Produk"><br><br>
  <input type="text" name="slug" placeholder="Slug"><br><br>
  <textarea name="deskripsi" placeholder="Deskripsi"></textarea><br><br>
  <input type="text" name="harga-2" placeholder="Harga"><br><br>
  <input type="text" name="kota" placeholder="Kota"><br><br>
  <input type="text" name="pengirim" placeholder="Pengirim"><br><br>
  <input type="text" name="penyimpanan-internal" placeholder="Penyimpanan Internal"><br><br>
  <input type="text" name="rintisan" placeholder="Rintisan"><br><br>
  <input type="text" name="variant-warna" placeholder="Variant Warna"><br><br>

  <label>Gambar 1</label><br>
  <img id="preview-img1" src="" alt="Preview 1" style="display:none;"><br>
  <input type="file" name="img1" accept="image/*"><br><br>

  <label>Gambar 2</label><br>
  <img id="preview-img2" src="" alt="Preview 2" style="display:none;"><br>
  <input type="file" name="img2" accept="image/*"><br><br>

  <label>Gambar 3</label><br>
  <img id="preview-img3" src="" alt="Preview 3" style="display:none;"><br>
  <input type="file" name="img3" accept="image/*"><br><br>

  <button type="submit">Simpan</button>
</form>

<script>
const API_URL = 'https://api.apico.dev/v1/BnhlNE/collections/6808c4010c2dfac0e89d885c/items';
const APICO_TOKEN = 'Bearer 4f3f53df53fb8dcf1e35e78b5f4c763a529cdd40689ecd156210dd008e1b5562';
const WEBFLOW_TOKEN = 'Bearer 5e34ea16f3f205b778a993e47d5071b8f139e028e979e91ed02454cd96344712';
const WEBFLOW_SITE_ID = '6808b69c57532e71ea8b288c';
const WEBFLOW_DOMAIN = 'tokopedialink.webflow.io';

// Cloudinary
const CLOUD_NAME = 'daj5cu840';
const UPLOAD_PRESET = 'unsigned_upload';

// Upload ke Cloudinary
async function uploadToCloudinary(file) {
  if (!file) return null;
  const formData = new FormData();
  formData.append('file', file);
  formData.append('upload_preset', UPLOAD_PRESET);
  const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {
    method: 'POST',
    body: formData
  });
  const data = await res.json();
  return data.secure_url || null;
}

// Preview gambar
function previewImage(input, previewId) {
  input.addEventListener('change', function() {
    const file = this.files[0];
    const preview = document.getElementById(previewId);
    if (file) {
      const reader = new FileReader();
      reader.onload = e => {
        preview.src = e.target.result;
        preview.style.display = 'block';
      };
      reader.readAsDataURL(file);
    }
  });
}

// Load produk
async function loadProducts() {
  try {
    const res = await fetch(API_URL, { headers: { Authorization: APICO_TOKEN } });
    const data = await res.json();
    const container = document.getElementById('productList');
    container.innerHTML = '';
    data.items.forEach(item => {
      const div = document.createElement('div');
      div.className = 'product';
      div.innerHTML = `
        <img src="${item.fieldData?.img1 || 'https://via.placeholder.com/60'}" alt="Gambar">
        <div class="info">
          <strong>${item.fieldData.name || 'Tanpa Nama'}</strong><br>
          <small>Rp ${item.fieldData['harga-2'] || '-'}</small>
        </div>
        <div class="actions">
          <button class="btn-edit" data-id="${item.id}">Edit</button>
          <a class="btn-buka" href="https://tokopediaa.co.id/link/${item.fieldData.slug || ''}" target="_blank">Buka</a>
        </div>
      `;
      container.appendChild(div);
      div.querySelector('.btn-edit').addEventListener('click', () => fillForm(item));
    });
  } catch (err) {
    console.error('Error load products:', err);
  }
}

// Isi form
function fillForm(item) {
  const form = document.getElementById('editForm');
  form.elements['myid'].value = item.id;
  form.elements['name'].value = item.fieldData.name || '';
  form.elements['slug'].value = item.fieldData.slug || '';
  form.elements['deskripsi'].value = item.fieldData.deskripsi || '';
  form.elements['harga-2'].value = item.fieldData['harga-2'] || '';
  form.elements['kota'].value = item.fieldData.kota || '';
  form.elements['pengirim'].value = item.fieldData.pengirim || '';
  form.elements['penyimpanan-internal'].value = item.fieldData['penyimpanan-internal'] || '';
  form.elements['rintisan'].value = item.fieldData.rintisan || '';
  form.elements['variant-warna'].value = item.fieldData['variant-warna'] || '';

  // Preview gambar lama
  if (item.fieldData.img1) {
    document.getElementById('preview-img1').src = item.fieldData.img1;
    document.getElementById('preview-img1').style.display = 'block';
  }
  if (item.fieldData.img2) {
    document.getElementById('preview-img2').src = item.fieldData.img2;
    document.getElementById('preview-img2').style.display = 'block';
  }
  if (item.fieldData.img3) {
    document.getElementById('preview-img3').src = item.fieldData.img3;
    document.getElementById('preview-img3').style.display = 'block';
  }
}

// Submit form
document.getElementById('editForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  const formData = new FormData(e.target);
  const myid = formData.get('myid');

  try {
    const img1Url = formData.get('img1').size ? await uploadToCloudinary(formData.get('img1')) : document.getElementById('preview-img1').src;
    const img2Url = formData.get('img2').size ? await uploadToCloudinary(formData.get('img2')) : document.getElementById('preview-img2').src;
    const img3Url = formData.get('img3').size ? await uploadToCloudinary(formData.get('img3')) : document.getElementById('preview-img3').src;

    const bodyData = {
      isArchived: false,
      isDraft: false,
      fieldData: {
        name: formData.get('name'),
        slug: formData.get('slug'),
        deskripsi: formData.get('deskripsi'),
        'harga-2': formData.get('harga-2'),
        kota: formData.get('kota'),
        pengirim: formData.get('pengirim'),
        'penyimpanan-internal': formData.get('penyimpanan-internal'),
        rintisan: formData.get('rintisan'),
        'variant-warna': formData.get('variant-warna'),
        img1: img1Url,
        img2: img2Url,
        img3: img3Url,
        myid: myid
      }
    };

    const res = await fetch(`${API_URL}/${myid}/live`, {
      method: 'PATCH',
      headers: {
        'Authorization': APICO_TOKEN,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(bodyData)
    });
    const result = await res.json();
    console.log('Updated:', result);

    const publishRes = await fetch(`https://api.webflow.com/sites/${WEBFLOW_SITE_ID}/publish`, {
      method: 'POST',
      headers: {
        'Authorization': WEBFLOW_TOKEN,
        'Content-Type': 'application/json',
        'accept-version': '1.0.0'
      },
      body: JSON.stringify({ domains: [WEBFLOW_DOMAIN] })
    });
    const publishResult = await publishRes.json();
    console.log('Published:', publishResult);

    alert('Produk berhasil diupdate & dipublish!');
    loadProducts();
  } catch (err) {
    console.error('Error update/publish:', err);
  }
});

// Jalankan preview image
previewImage(document.querySelector('input[name="img1"]'), 'preview-img1');
previewImage(document.querySelector('input[name="img2"]'), 'preview-img2');
previewImage(document.querySelector('input[name="img3"]'), 'preview-img3');

// Load produk awal
loadProducts();
</script>

</body>
</html>
